# Huma Migration Plan

Migrate the HTTP handler layer from raw Echo handlers + swaggo annotations to
Huma v2, replacing the OpenAPI generation approach from comment-annotation-based
(`swag init`) to type-driven (runtime generation from Go structs). Add Portman
for Postman collection generation with contract tests and custom scripts. Lay
groundwork for a separate Cobra CLI + Viper client binary.

## Goals

1. **Clean handler code** -- Eliminate swaggo `@Summary`/`@Router` comment
   annotations and manual `strconv.Atoi`/`c.QueryParam` parsing boilerplate.
   Handler logic should be business logic, not HTTP plumbing.
2. **Spec-from-types** -- OpenAPI 3.1 spec generated at runtime from Go
   input/output structs. Always in sync with code. No `swag init` build step.
3. **Postman pipeline** -- Replace bare `openapi2postmanv2` with Portman for
   auto-generated contract tests, custom scripts, auth, and environment
   variables that survive regeneration.
4. **`humacli` for the API server** -- Migrate `cmd/server-price-tracker/` from
   raw Cobra to `humacli`. Gets type-safe options structs, automatic env var
   binding (`SERVICE_` prefix), and lifecycle hooks (`OnStart`/`OnStop`) -- all
   built on Cobra under the hood.
5. **`spt` CLI client** -- Separate `cmd/spt/` binary (binary name: `spt`) using
   Cobra + Viper that consumes the API remotely. Same role as `kubectl` to a
   Kubernetes API server -- a lightweight client for submitting commands, queries,
   searches. Decoupled from the server binary.
6. **Incremental migration** -- Raw Echo routes and Huma routes coexist. Migrate
   one handler at a time with tests passing at every step.

## Non-Goals

- Replacing Echo with a different router (Huma layers on top via `humaecho`
  adapter)
- Echo v5 upgrade (v4 supported through end of 2026, `humaecho` targets v4)
- Restish as CLI replacement (we want a full Cobra + Viper CLI binary)
- Frontend TypeScript generation (future work, but the spec will support it)

## Architecture

### Before

```
cmd/server-price-tracker/
  main.go              -- @title/@version swaggo annotations
  cmd/serve.go         -- imports api/openapi, calls openapi.RegisterRoutes(e)

internal/api/handlers/
  health.go            -- swaggo annotations + echo.Context handlers
  watches.go           -- swaggo annotations + manual c.Param()/c.Bind()
  listings.go          -- swaggo annotations + 6x strconv.Atoi + 6x c.QueryParam
  extract.go           -- swaggo annotations + c.Bind()
  search.go            -- swaggo annotations + c.Bind()
  trigger.go           -- swaggo annotations
  rescore.go           -- swaggo annotations
  doc.go               -- ErrorResponse/StatusResponse swagger types

api/openapi/
  docs.go              -- generated by swag init (embeds spec template)
  handler.go           -- custom Swagger UI serving via embed.FS
  swagger.json         -- generated static spec
  swagger.yaml         -- generated static spec
```

### After

```
cmd/server-price-tracker/
  main.go              -- humacli entry point with typed options struct
                          (replaces raw Cobra setup, humacli uses Cobra under the hood)
                          env var binding (SERVICE_ prefix), lifecycle hooks

cmd/spt/               -- NEW: lightweight API client binary (like kubectl)
  main.go              -- Cobra root command + Viper config
  cmd/
    root.go            -- base URL, auth, output format flags via Viper
    watches.go         -- list, get, create, update, delete, enable/disable
    listings.go        -- list, get
    ingest.go          -- trigger ingestion
    extract.go         -- one-off extraction
    search.go          -- eBay search
    baselines.go       -- refresh baselines
    rescore.go         -- rescore listings

internal/api/handlers/
  health.go            -- Huma operation, typed input/output structs
  watches.go           -- Huma operations, no manual parsing
  listings.go          -- Huma operations, query params as struct fields with tags
  extract.go           -- Huma operation, typed request/response
  search.go            -- Huma operation, typed request/response
  trigger.go           -- Huma operations, no-input handlers
  rescore.go           -- Huma operation
  (doc.go removed)     -- ErrorResponse replaced by Huma's RFC 9457 errors

api/openapi/           -- removed entirely (spec served at runtime by Huma)

portman/               -- NEW: Postman pipeline config
  portman-config.json  -- contract tests, variation tests, custom scripts
  scripts/             -- custom pre-request and test JS files
  environments/        -- dev.json, staging.json environment files
```

### Handler Signature Change

Every handler method changes from Echo-style to Huma-style:

```go
// Before: echo.Context handler
func (h *WatchHandler) List(c echo.Context) error {
    enabledOnly := c.QueryParam("enabled") == "true"
    watches, err := h.store.ListWatches(c.Request().Context(), enabledOnly)
    if err != nil {
        return c.JSON(http.StatusInternalServerError, map[string]string{"error": err.Error()})
    }
    return c.JSON(http.StatusOK, watches)
}

// After: Huma typed handler (registered via huma.Register)
type ListWatchesInput struct {
    Enabled *bool `query:"enabled" doc:"Filter by enabled status"`
}

type ListWatchesOutput struct {
    Body []domain.Watch
}

func (h *WatchHandler) ListWatches(ctx context.Context, input *ListWatchesInput) (*ListWatchesOutput, error) {
    enabledOnly := input.Enabled != nil && *input.Enabled
    watches, err := h.store.ListWatches(ctx, enabledOnly)
    if err != nil {
        return nil, huma.Error500InternalServerError("listing watches failed")
    }
    return &ListWatchesOutput{Body: watches}, nil
}
```

### Registration Change

```go
// Before: direct Echo route registration
watchH := handlers.NewWatchHandler(s)
api.GET("/watches", watchH.List)

// After: Huma operation registration
watchH := handlers.NewWatchHandler(s)
huma.Register(humaAPI, huma.Operation{
    OperationID: "list-watches",
    Method:      http.MethodGet,
    Path:        "/api/v1/watches",
    Summary:     "List watches",
    Description: "Returns all watches, optionally filtered by enabled status.",
    Tags:        []string{"watches"},
}, watchH.ListWatches)
```

## Phases

### Phase 0: Add Huma dependency, scaffold, and migrate server to `humacli`

**Branch:** `feat/huma-migration` (current)

- [x] `go get github.com/danielgtaylor/huma/v2@latest`
- [x] Migrate `cmd/server-price-tracker/` from raw Cobra to `humacli`:
  - Define a typed `Options` struct for server config (host, port, config file
    path) with struct tags for flags, defaults, and env vars
  - Replace `rootCmd`/`serveCmd`/`migrateCmd` with `humacli.New()` + custom
    subcommands via `cli.Root().AddCommand(...)`
  - Wire `hooks.OnStart()` for server startup, `hooks.OnStop()` for graceful
    shutdown
  - Existing config loading (`internal/config`) stays -- `humacli` handles the
    CLI flags/env, config YAML loading remains separate
- [ ] Create `internal/api/routes.go` -- new file for Huma operation
      registration (deferred to Phase 1 when first Huma operations are added;
      `registerRoutes` in serve.go already accepts `huma.API`)
- [x] Wire Huma in the server startup:
  - Keep `echo.New()` + all existing middleware (Recovery, RequestLog, Metrics)
  - Add `humaAPI := humaecho.New(e, humaConfig)` after middleware setup
  - Pass both `e` (for raw Echo routes during migration) and `humaAPI` to the
    registration function
- [x] Verify: `make build && make test && make lint` -- no behavior change, just
      wiring

**Success criteria:** Server starts via `humacli`, all existing routes work,
Huma's `/openapi.json` endpoint serves a (mostly empty) spec, `/docs` serves
Huma's built-in docs UI. `SERVICE_HOST`, `SERVICE_PORT` env vars work
automatically.

### Phase 1: Migrate zero-input handlers (health, trigger, rescore)

These handlers take no request parameters, making them the simplest migration
targets.

**health.go** (2 endpoints, 0 parsing boilerplate):

- [ ] Define `HealthzOutput`, `ReadyzOutput` structs
- [ ] Rewrite `Healthz` and `Readyz` as Huma handlers
- [ ] Register via `huma.Register()` instead of `e.GET()`
- [ ] Remove swaggo annotations
- [ ] Update `health_test.go` to use `humatest`

**trigger.go** (2 endpoints, 0 parsing boilerplate):

- [ ] Define `IngestOutput`, `RefreshOutput` structs
- [ ] Rewrite `Ingest` and `Refresh` as Huma handlers
- [ ] Register via `huma.Register()`
- [ ] Remove swaggo annotations
- [ ] Update `trigger_test.go` to use `humatest`

**rescore.go** (1 endpoint, 0 parsing boilerplate):

- [ ] Define `RescoreOutput` struct
- [ ] Rewrite `Rescore` as Huma handler
- [ ] Register via `huma.Register()`
- [ ] Remove swaggo annotations
- [ ] Update `rescore_test.go` to use `humatest`

**Success criteria:** 5 endpoints migrated. `make test` passes. Huma spec at
`/openapi.json` includes these 5 operations. Raw Echo routes still serve the
remaining endpoints.

### Phase 2: Migrate body-input handlers (extract, search)

These handlers use `c.Bind()` for JSON body parsing. Huma replaces this with
typed `Body` fields on the input struct.

**extract.go** (1 endpoint):

- [ ] Move `extractRequest`/`extractResponse` to Huma input/output types with
      `doc` and `example` tags
- [ ] Rewrite `Extract` as Huma handler -- validation (non-empty title) moves to
      struct tags (`minLength:"1"`)
- [ ] Register via `huma.Register()`
- [ ] Remove swaggo annotations
- [ ] Update `extract_test.go` to use `humatest`

**search.go** (1 endpoint):

- [ ] Move `searchRequest` to Huma input type with `doc` and `example` tags
- [ ] Rewrite `Search` as Huma handler -- limit validation moves to struct tags
      (`minimum:"1"`)
- [ ] Register via `huma.Register()`
- [ ] Remove swaggo annotations
- [ ] Update `search_test.go` to use `humatest`

**Success criteria:** 7 endpoints migrated. `make test` passes.

### Phase 3: Migrate watches handler (path params + body)

The watches handler has the most endpoints (6) and uses both path params and
body binding.

**watches.go** (6 endpoints):

- [ ] Define input/output types for each operation:
  - `ListWatchesInput` (query: `enabled`), `ListWatchesOutput` (body:
    `[]domain.Watch`)
  - `GetWatchInput` (path: `id`), `GetWatchOutput` (body: `domain.Watch`)
  - `CreateWatchInput` (body: `domain.Watch`), `CreateWatchOutput` (body:
    `domain.Watch`, status 201)
  - `UpdateWatchInput` (path: `id`, body: `domain.Watch`), `UpdateWatchOutput`
    (body: `domain.Watch`)
  - `SetWatchEnabledInput` (path: `id`, body: `{enabled bool}`),
    `SetWatchEnabledOutput`
  - `DeleteWatchInput` (path: `id`), no output (status 204)
- [ ] Rewrite all 6 handlers as Huma handlers
- [ ] Path param `id` becomes a struct field with `path:"id" doc:"Watch UUID"`
- [ ] Register all via `huma.Register()`
- [ ] Remove swaggo annotations
- [ ] Update `watches_test.go` to use `humatest`

**Success criteria:** 13 endpoints migrated. `make test` passes.

### Phase 4: Migrate listings handler (heavy query params)

The listings handler has the most parsing boilerplate (~25 lines of
`strconv.Atoi` + `c.QueryParam`). This is where Huma's struct-tag validation
eliminates the most code.

**listings.go** (2 endpoints):

- [ ] Define `ListListingsInput` with typed query param fields:
  ```go
  type ListListingsInput struct {
      ComponentType *string `query:"component_type" enum:"ram,drive,server,cpu,nic,other" doc:"Filter by component type"`
      ProductKey    *string `query:"product_key" doc:"Filter by product key"`
      MinScore      *int    `query:"min_score" minimum:"0" maximum:"100" doc:"Minimum composite score"`
      MaxScore      *int    `query:"max_score" minimum:"0" maximum:"100" doc:"Maximum composite score"`
      Limit         *int    `query:"limit" minimum:"1" maximum:"1000" doc:"Number of results (default 50)"`
      Offset        *int    `query:"offset" minimum:"0" doc:"Pagination offset"`
      OrderBy       *string `query:"order_by" enum:"score,price,first_seen_at" doc:"Sort field"`
  }
  ```
- [ ] Define `ListListingsOutput` (body: `listingsResponse`)
- [ ] Define `GetListingInput` (path: `id`), `GetListingOutput` (body:
      `domain.Listing`)
- [ ] Rewrite both handlers -- all `strconv.Atoi` boilerplate eliminated
- [ ] Register via `huma.Register()`
- [ ] Remove swaggo annotations
- [ ] Update `listings_test.go` to use `humatest`

**Success criteria:** All 15 endpoints migrated. `make test` passes. Zero swaggo
annotations remain.

### Phase 5: Remove swaggo and clean up

- [ ] Delete `api/openapi/` directory entirely (docs.go, handler.go,
      swagger.json, swagger.yaml)
- [ ] Delete `internal/api/handlers/doc.go` (ErrorResponse/StatusResponse no
      longer needed)
- [ ] Remove swaggo annotations from `cmd/server-price-tracker/main.go`
- [ ] Remove `github.com/swaggo/swag/v2` from `go.mod`
- [ ] Remove `go:github.com/swaggo/swag/v2/cmd/swag` from `mise.toml`
- [ ] Update `scripts/makefiles/go.mk`:
  - Remove `swagger` target
  - Update `postman` target to curl the running spec or export from a test
    helper
  - Update `generate` target to remove `swagger` dependency
- [ ] Run `go mod tidy`
- [ ] Verify: `make build && make test && make lint`

**Success criteria:** No swaggo dependency. Huma serves the full spec at
`/openapi.json`. `/docs` serves the interactive docs UI. Build is clean.

### Phase 6: Postman pipeline with Portman

Replace `openapi2postmanv2` with Portman for a fully-featured Postman
collection.

- [ ] Add `npm:@apideck/portman` to `mise.toml`
- [ ] Add `npm:newman` to `mise.toml`
- [ ] Create `portman/portman-config.json`:
  - Contract tests for all endpoints (status codes, response time, content-type,
    JSON schema validation)
  - Variation tests for create/update endpoints (missing required fields -> 422)
  - Global auth configuration (if applicable)
  - Environment variable references for base URL
- [ ] Create `portman/environments/dev.json` with
      `baseUrl: http://localhost:8080`
- [ ] Create `portman/scripts/` directory for custom test JS files (if needed)
- [ ] Update `scripts/makefiles/go.mk`:

  ```makefile
  postman: ## Generate Postman collection with contract tests
      @portman -l http://localhost:8080/openapi.json \
          -c portman/portman-config.json \
          -o api/postman_collection.json
      @echo "Postman collection generated"

  postman-test: postman ## Run Postman collection tests via Newman
      @newman run api/postman_collection.json \
          -e portman/environments/dev.json
  ```

- [ ] Alternative: add a `make postman-from-spec` target that exports the spec
      from a test helper (no running server needed):
  ```makefile
  postman-from-spec: ## Generate Postman collection from exported spec
      @go run ./cmd/export-openapi > api/openapi.json
      @portman -l api/openapi.json \
          -c portman/portman-config.json \
          -o api/postman_collection.json
  ```
- [ ] Remove `npm:openapi-to-postmanv2` from `mise.toml`

**Success criteria:** `make postman` generates a collection with auto-generated
contract tests. `make postman-test` runs the collection against a local server
via Newman. Custom test scripts survive regeneration.

### Phase 7: `spt` CLI client binary (`cmd/spt/`)

Separate lightweight CLI binary (binary name: `spt`) that consumes the HTTP API.
Same relationship as `kubectl` to the Kubernetes API server -- a remote client
for submitting commands, queries, and searches. Eventually the frontend will do
the same thing via HTTP; this is the terminal equivalent.

Uses Cobra for commands and Viper for configuration (server URL, auth, output
format).

- [ ] Create `cmd/spt/main.go` -- Cobra root command
- [ ] Create `cmd/spt/cmd/root.go`:
  - Viper config: `~/.spt.yaml` or env vars
  - Persistent flags: `--server` (base URL, default `http://localhost:8080`),
    `--output` (json/table/yaml)
  - `initConfig()` via Viper with env prefix `SPT`
- [ ] Create API client package `internal/api/client/` (or reuse existing if
      suitable):
  - Typed methods matching each API operation
  - Configurable base URL, HTTP client, auth headers
  - Error handling that maps Huma's RFC 9457 errors to CLI-friendly messages
- [ ] Create CLI command files:
  - `cmd/spt/cmd/watches.go` -- `spt watches list`, `spt watches get <id>`,
    `spt watches create --name "..." --query "..." --component-type ram`,
    `spt watches update <id>`, `spt watches enable <id>`,
    `spt watches disable <id>`, `spt watches delete <id>`
  - `cmd/spt/cmd/listings.go` --
    `spt listings list --component-type ram --min-score 70`,
    `spt listings get <id>`
  - `cmd/spt/cmd/ingest.go` -- `spt ingest`
  - `cmd/spt/cmd/extract.go` -- `spt extract --title "Samsung 32GB DDR4..."`
  - `cmd/spt/cmd/search.go` -- `spt search --query "DDR4 ECC REG"`
  - `cmd/spt/cmd/baselines.go` -- `spt baselines refresh`
  - `cmd/spt/cmd/rescore.go` -- `spt rescore`
- [ ] Add `spt` build target to Makefile
- [ ] Add `spt` to GoReleaser config for cross-platform builds

**Success criteria:** `spt watches list` calls `GET /api/v1/watches` and prints
results. All 15 API operations have CLI commands. Viper reads config from file,
env, and flags.

### Phase 8: Documentation and CLAUDE.md updates

- [ ] Update `CLAUDE.md`:
  - Remove swaggo/swagger references
  - Add Huma info to architecture section
  - Document `/openapi.json`, `/openapi-3.0.json`, `/docs` endpoints
  - Add `make postman` (Portman) and `make postman-test` (Newman) to build
    commands
  - Add `cmd/spt/` to project layout
  - Update Key API Endpoints section
- [ ] Update `docs/DESIGN.md` if it references swaggo or the old handler
      patterns
- [ ] Move this plan to `docs/plans/huma-migration.md` (done)

**Success criteria:** All docs reflect the new architecture. New contributors
can understand the Huma handler pattern from CLAUDE.md.

## Error Response Strategy

Huma defaults to RFC 9457 Problem Details:

```json
{
  "status": 422,
  "title": "Unprocessable Entity",
  "detail": "validation failed",
  "errors": [
    {
      "message": "expected string length >= 1",
      "location": "body.title",
      "value": ""
    }
  ]
}
```

Our current handlers return `{"error": "message"}`. Since we don't have external
consumers yet, we adopt RFC 9457 as the standard error format. The CLI will
parse `detail` and `errors` for user-friendly output.

## Dependency Changes

### Added

- `github.com/danielgtaylor/huma/v2` -- Huma framework
- `github.com/spf13/viper` -- CLI config (for spt-cli)
- `npm:@apideck/portman` -- Postman collection generation with tests
- `npm:newman` -- Postman collection runner

### Removed

- `github.com/swaggo/swag/v2` -- No longer needed (Huma generates spec)
- `npm:openapi-to-postmanv2` -- Replaced by Portman
- `go:github.com/swaggo/swag/v2/cmd/swag` -- CLI tool no longer needed

### Unchanged

- `github.com/labstack/echo/v4` -- Huma layers on top via `humaecho` adapter
- `github.com/spf13/cobra` -- `humacli` uses Cobra under the hood for the
  server; `spt` CLI uses Cobra directly
- All existing middleware, store, engine, ebay, notify, extract packages

## Migration Risk Assessment

| Risk                                           | Likelihood | Impact | Mitigation                                                                                                      |
| ---------------------------------------------- | ---------- | ------ | --------------------------------------------------------------------------------------------------------------- |
| `humaecho` adapter edge cases                  | Low        | Medium | Chi is more popular, but Echo adapter is official and tested. Run full test suite after each handler migration. |
| Test rewrite effort                            | Certain    | Medium | Tests must change from `httptest`+`echo.NewContext` to `humatest`. Mechanical change, not logic change.         |
| RFC 9457 error format breaks CLI client        | Medium     | Low    | No external consumers. Internal CLI migrates simultaneously.                                                    |
| Huma validation differs from manual validation | Low        | Medium | Table-driven tests catch behavior differences. Compare Huma validation against existing test cases.             |
| Handler registration complexity                | Low        | Low    | `huma.Register()` is verbose but explicit. Move registration to a dedicated `routes.go` file.                   |

## Files Changed

| File                                     | Action                                                 | Phase |
| ---------------------------------------- | ------------------------------------------------------ | ----- |
| `go.mod` / `go.sum`                      | Add huma/v2                                            | 0     |
| `mise.toml`                              | Add portman, newman; remove swag, openapi-to-postmanv2 | 0, 6  |
| `cmd/server-price-tracker/main.go`       | Migrate to `humacli` entry point                       | 0     |
| `cmd/server-price-tracker/cmd/serve.go`  | Add humaecho adapter, update registration              | 0     |
| `internal/api/routes.go`                 | **New** -- Huma operation registration                 | 0     |
| `internal/api/handlers/health.go`        | Rewrite to Huma handlers                               | 1     |
| `internal/api/handlers/health_test.go`   | Rewrite to humatest                                    | 1     |
| `internal/api/handlers/trigger.go`       | Rewrite to Huma handlers                               | 1     |
| `internal/api/handlers/trigger_test.go`  | Rewrite to humatest                                    | 1     |
| `internal/api/handlers/rescore.go`       | Rewrite to Huma handlers                               | 1     |
| `internal/api/handlers/rescore_test.go`  | Rewrite to humatest                                    | 1     |
| `internal/api/handlers/extract.go`       | Rewrite to Huma handlers                               | 2     |
| `internal/api/handlers/extract_test.go`  | Rewrite to humatest                                    | 2     |
| `internal/api/handlers/search.go`        | Rewrite to Huma handlers                               | 2     |
| `internal/api/handlers/search_test.go`   | Rewrite to humatest                                    | 2     |
| `internal/api/handlers/watches.go`       | Rewrite to Huma handlers                               | 3     |
| `internal/api/handlers/watches_test.go`  | Rewrite to humatest                                    | 3     |
| `internal/api/handlers/listings.go`      | Rewrite to Huma handlers                               | 4     |
| `internal/api/handlers/listings_test.go` | Rewrite to humatest                                    | 4     |
| `internal/api/handlers/doc.go`           | **Delete**                                             | 5     |
| `api/openapi/`                           | **Delete** entire directory                            | 5     |
| `cmd/server-price-tracker/main.go`       | Remove swaggo annotations (already done in Phase 0)    | 5     |
| `scripts/makefiles/go.mk`                | Update postman target, remove swagger target           | 5, 6  |
| `portman/portman-config.json`            | **New** -- Portman config                              | 6     |
| `portman/environments/dev.json`          | **New** -- Dev environment                             | 6     |
| `cmd/spt/`                               | **New** -- `spt` CLI client binary                     | 7     |
| `internal/api/client/`                   | Update/extend for CLI use                              | 7     |
| `CLAUDE.md`                              | Update docs                                            | 8     |

## Verification Per Phase

Every phase must pass before moving to the next:

```bash
make build          # both binaries compile
make test           # all unit tests pass
make lint           # zero lint issues
```

After Phase 5 (cleanup), additionally:

```bash
curl localhost:8080/openapi.json    # full OpenAPI 3.1 spec
curl localhost:8080/openapi-3.0.json # downgraded 3.0.3 spec
open localhost:8080/docs            # Huma docs UI
```

After Phase 6 (Portman):

```bash
make postman        # generates collection with tests
make postman-test   # runs collection against local server
```

After Phase 7 (CLI):

```bash
spt watches list --server http://localhost:8080
spt listings list --component-type ram --min-score 70
```
