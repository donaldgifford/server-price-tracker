---
suite: deployment
templates:
  - templates/deployment.yaml
  - templates/configmap.yaml
tests:
  - it: renders a Deployment with correct kind and name
    template: templates/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-server-price-tracker

  - it: has correct labels
    template: templates/deployment.yaml
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            app.kubernetes.io/name: server-price-tracker
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm

  - it: uses appVersion as default image tag
    template: templates/deployment.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "ghcr.io/donaldgifford/server-price-tracker:\\d+\\.\\d+\\.\\d+"

  - it: allows custom image tag override
    template: templates/deployment.yaml
    set:
      image.tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/donaldgifford/server-price-tracker:v1.2.3"

  - it: has correct container args
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].args
          value:
            - serve
            - --config
            - /etc/spt/config.yaml

  - it: has correct container port
    template: templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: http

  - it: mounts config volume at /etc/spt as readOnly
    template: templates/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: config
            mountPath: /etc/spt
            readOnly: true

  - it: references the secret via envFrom
    template: templates/deployment.yaml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: RELEASE-NAME-server-price-tracker-secrets

  - it: renders liveness and readiness probes by default
    template: templates/deployment.yaml
    asserts:
      - isNotEmpty:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - isNotEmpty:
          path: spec.template.spec.containers[0].readinessProbe
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /readyz

  - it: can disable probes by setting them to null
    template: templates/deployment.yaml
    set:
      livenessProbe: null
      readinessProbe: null
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe

  - it: renders migration init container when enabled
    template: templates/deployment.yaml
    set:
      migration.enabled: true
    asserts:
      - isNotEmpty:
          path: spec.template.spec.initContainers
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: migrate
      - equal:
          path: spec.template.spec.initContainers[0].command
          value:
            - server-price-tracker
            - migrate
            - --config
            - /etc/spt/config.yaml

  - it: does not render migration init container when disabled
    template: templates/deployment.yaml
    set:
      migration.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.initContainers

  - it: renders CNPG env vars when cnpg is enabled
    template: templates/deployment.yaml
    set:
      cnpg.enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_HOST
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-server-price-tracker-db-app
                key: host
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_USER
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-server-price-tracker-db-app
                key: username
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-server-price-tracker-db-app
                key: password
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DB_NAME
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-server-price-tracker-db-app
                key: dbname

  - it: does not set replicas when autoscaling is enabled
    template: templates/deployment.yaml
    set:
      autoscaling.enabled: true
    asserts:
      - isNull:
          path: spec.replicas

  - it: sets replicas when autoscaling is disabled
    template: templates/deployment.yaml
    set:
      autoscaling.enabled: false
      replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: has checksum/config annotation
    template: templates/deployment.yaml
    asserts:
      - isNotEmpty:
          path: spec.template.metadata.annotations["checksum/config"]
